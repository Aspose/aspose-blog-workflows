name: Staging

on:
  workflow_dispatch:

# Prevents multiple deployments from running at the same time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =================================================
  # 1) PARALLEL PRODUCT BUILDS (HTML ONLY)
  # =================================================
  build-product:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        product:
          - 3d
          - barcode
          - cad
          - cells
          - diagram
          - drawing
          - email
          - finance
          - font
          - gis
          - html
          - imaging
          - medical
          - note
          - ocr
          - omr
          - page
          - pdf
          - psd
          - pub
          - slides
          - svg
          - tasks
          - tex
          - total
          - words
          - zip

    steps:
      # --------------------------------------
      # Checkout blog repo
      # --------------------------------------
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: Aspose/aspose-blog
          ref: master
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0

      # --------------------------------------
      # Setup Hugo
      # --------------------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.120.4'
          extended: true

      # --------------------------------------
      # Cache Hugo (per product)
      # --------------------------------------
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources/_gen
            .hugo_build.lock
          key: hugo-${{ runner.os }}-${{ matrix.product }}-${{ hashFiles(format('content/Aspose.Blog/{0}/**', matrix.product)) }}
          restore-keys: |
            hugo-${{ runner.os }}-${{ matrix.product }}-

      # --------------------------------------
      # Build ONLY product pages (NO global files)
      # --------------------------------------
      - name: Build product - ${{ matrix.product }}
        run: |
          # We build the specific product sub-folder. 
          # We disable global kinds to save time and prevent partial sitemaps.
          hugo \
            --config "config.yml,config.staging.yml" \
            -b "https://blog-qa.aspose.com/" \
            --contentDir content/Aspose.Blog/${{ matrix.product }} \
            --destination public \
            --disableKinds sitemap,rss,taxonomy,term \
            --minify

      # --------------------------------------
      # Upload product artifact
      # --------------------------------------
      - name: Upload product artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.product }}
          path: public

  # =================================================
  # 2) GLOBAL MERGE + METADATA + DEPLOY
  # =================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-product

    steps:
      # --------------------------------------
      # Checkout repo again
      # --------------------------------------
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: Aspose/aspose-blog
          ref: master
          token: ${{ secrets.REPO_TOKEN }}

      # --------------------------------------
      # Setup Hugo
      # --------------------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.120.4'
          extended: true

      # --------------------------------------
      # Download product artifacts
      # --------------------------------------
      - name: Download all product artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged-artifacts
      
      # --------------------------------------
      # Merge product outputs
      # --------------------------------------
      - name: Merge product outputs
        run: |
          mkdir -p public
          # This copies the content of every artifact folder into the public folder
          # It preserves the /ar/ and /product/ structures because of your hardcoded URLs
          find merged-artifacts -maxdepth 2 -mindepth 2 -type d -exec cp -r {}/ public/ \;
          # Cleanup the downloader folder to keep the workspace clean
          rm -rf merged-artifacts

      # --------------------------------------
      # GLOBAL BUILD (INDEXES ONLY â€“ NO HTML)
      # --------------------------------------
      - name: Global build (Sitemap + Search + RSS)
        run: |
          # This step scans the ENTIRE content directory to generate a valid 
          # index.json and sitemap.xml. We do NOT disable 'home'.
          # We disable 'page' and 'section' to avoid re-rendering HTML that we just merged.
          hugo \
            --config "config.yml,config.staging.yml" \
            -b "https://blog-qa.aspose.com/" \
            --disableKinds page,section \
            --minify

      # --------------------------------------
      # Deploy to S3 (Staging)
      # --------------------------------------
      - name: Deploy to S3 (Staging)
        run: |
          # Hugo deploy will sync the 'public' folder (merged HTML + global JSON/XML) to S3
          hugo deploy \
            --maxDeletes -1 \
            --config "config.yml,config.staging.yml" \
            --target "staging"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

      # --------------------------------------
      # CloudFront Invalidation
      # --------------------------------------
      - name: Invalidate CloudFront (Staging)
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
          PATHS: '/*'
          AWS_REGION: 'us-west-2'
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}



# name: Staging

# on:
# #   push:
# #     branches:
# #         - main  # Set a branch to deploy
# #     Allows you to run this workflow manually from the Actions tab
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout blog repo
#         uses: actions/checkout@main
#         with:
#           repository: Aspose/aspose-blog
#           ref: master
#           token: ${{ secrets.REPO_TOKEN }}
#           #submodules: true  # Fetch Hugo themes (true OR recursive)
#           fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

#       - name: Setup Hugo - (Staging)
#         uses: peaceiris/actions-hugo@v2.4.13
#         with:
#           hugo-version: '0.101.0'
#           extended: true
      
#       - name: Build - (Staging)
#         run: hugo --config "config.yml,config.staging.yml" --cleanDestinationDir --minify
#         # run: hugo --config "config.yml" --cleanDestinationDir --minify
    
#       - name: Deploy Home to S3 - (Staging)
#         run: hugo deploy --maxDeletes -1 --config "config.yml,config.staging.yml" --target "staging"
#         # run: hugo deploy --maxDeletes -1 --target "production"

#         env:
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

#       - name: Invalidate CloudFront - (Staging)
#         uses: chetan/invalidate-cloudfront-action@v2
#         env:
#           DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
#           PATHS: '/*'
#           AWS_REGION: 'us-west-2'
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}
